<!DOCTYPE html>
<html>
<head>
    <title>Belanet Mapping Tool Improved</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS (pinned + SRI) -->
    <script src="https://cdn.tailwindcss.com/3.4.1" integrity="sha384-SOMLQz+nKv/ORIYXo3J3NrWJ33oBgGvkHlV9t8i70QVLq8ZtST9Np1gDsVUkk4xN" crossorigin="anonymous"></script>
    <!-- Lucide Icons (pinned UMD + SRI) -->
    <script src="https://unpkg.com/lucide@0.568.0/dist/umd/lucide.min.js" integrity="sha384-eiar3BCHV4A3ISksVAvClwS2VQfQa0LWccSYkkk2/UNldyer+2d205GVYzj65+VU" crossorigin="anonymous"></script>
    <!-- Animate.css (SRI) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" integrity="sha384-Gu3KVV2H9d+yA4QDpVB7VcOyhJlAVrcXd0thEjr4KznfaFPLe0xQJyonVxONa4ZC" crossorigin="anonymous"/>
    
    <script>
        if (window.tailwind) {
            tailwind.config = {
                darkMode: 'class',
                theme: {
                    extend: {
                        fontFamily: {
                            sans: ['Inter', 'sans-serif'],
                        },
                        colors: {
                            primary: {
                                50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd', 400: '#60a5fa', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 800: '#1e40af', 900: '#1e3a8a',
                            },
                        }
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="stylesheet.css">
</head>

<body>

<div id="app">
    <div id="simBanner" style="display: none; position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(124, 58, 237, 0.9); backdrop-filter: blur(8px); color: white; padding: 10px 24px; border-radius: 99px; z-index: 1000; font-weight: 700; box-shadow: 0 10px 25px rgba(124, 58, 237, 0.4); pointer-events: none; border: 1px solid rgba(255,255,255,0.2); font-size: 0.875rem; letter-spacing: 0.05em;">
        <i data-lucide="zap" style="display: inline-block; width: 16px; height: 16px; margin-right: 8px; vertical-align: middle;"></i>
        SIMULATION MODE ACTIVE
    </div>
    <button id="toggleBtn"></button>

    <div id="sidebar" class="custom-scrollbar">
        <div id="sidebarHeader">
            <span>Belanet Map</span>
            <div class="bg-primary-500/10 p-2 rounded-lg text-primary-600">
                <i data-lucide="map" class="w-5 h-5"></i>
            </div>
        </div>

        <!-- Tab navigation -->
        <div id="tabNavigation">
            <button class="tabBtn active" data-tab="general">
                <i data-lucide="layers" class="w-4 h-4 mb-1 mx-auto"></i>
                General
            </button>
            <button class="tabBtn" data-tab="towers">
                <i data-lucide="radio" class="w-4 h-4 mb-1 mx-auto"></i>
                Towers
            </button>
            <button class="tabBtn" data-tab="customers">
                <i data-lucide="users" class="w-4 h-4 mb-1 mx-auto"></i>
                Customers
            </button>
            <button class="tabBtn" data-tab="tasks">
                <i data-lucide="clipboard-list" class="w-4 h-4 mb-1 mx-auto"></i>
                Tasks
            </button>
            <button class="tabBtn" data-tab="playground">
                <i data-lucide="beaker" class="w-4 h-4 mb-1 mx-auto"></i>
                Play
            </button>
            <button class="tabBtn" data-tab="services">
                <i data-lucide="server" class="w-4 h-4 mb-1 mx-auto"></i>
                Services
            </button>
        </div>

        <!-- Tab content sections -->
        <div id="generalTab" class="tabContent active">
            <!-- Filter buttons -->
            <label class="section-label">Map Layers</label>
            <div id="filterButtons">
                <button id="toggleCustomersBtn" class="filter-button active">
                    <i data-lucide="user" class="w-3 h-3 inline-block mr-1"></i>
                    Customers
                </button>
                <button id="toggleTowersBtn" class="filter-button active">
                    <i data-lucide="tower-control" class="w-3 h-3 inline-block mr-1"></i>
                    Towers
                </button>
                <button id="toggleLinksBtn" class="filter-button active">
                    <i data-lucide="link" class="w-3 h-3 inline-block mr-1"></i>
                    Links
                </button>
                <button id="toggleTrackersBtn" class="filter-button active">
                    <i data-lucide="navigation" class="w-3 h-3 inline-block mr-1"></i>
                    Trackers
                </button>
                <button id="toggleWeatherBtn" class="filter-button">
                    <i data-lucide="cloud-lightning" class="w-3 h-3 inline-block mr-1"></i>
                    Weather
                </button>
            </div>

            <!-- Tracker refresh settings -->
            <div class="tab-section">
                <label class="section-label">Tracker Updates</label>
                <div class="tracker-refresh-controls">
                    <label class="filter-label">
                        <input type="checkbox" id="trackerAutoRefreshCheckbox" checked>
                        Auto-refresh
                    </label>
                    <div style="display: flex; align-items: center; gap: 8px; margin-top: 12px; background: rgba(0,0,0,0.03); padding: 8px; border-radius: 10px;">
                        <input type="number" id="trackerRefreshInterval" min="1" max="300" value="10" style="width: 50px; background: transparent; border: none; font-weight: 600; color: var(--primary-color);">
                        <span style="font-size: 0.75rem; color: #64748b; font-weight: 500;">seconds</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="towersTab" class="tabContent">
            <!-- Tower filter checkboxes -->
            <div class="tab-section">
                <label class="section-label">Filter by Tower</label>
                <div id="towerFilterCheckboxes" class="filter-container custom-scrollbar">
                </div>
                <div class="filter-buttons">
                    <button id="selectAllTowersBtn" class="filter-button-small">Select All</button>
                    <button id="clearAllTowersBtn" class="filter-button-small">Clear All</button>
                </div>
            </div>

            <!-- Hide unlinked towers checkbox -->
            <div class="tower-filter-section">
                <label class="filter-label">
                    <input type="checkbox" id="hideUnlinkedCheckbox">
                    Hide Unlinked Towers
                </label>
            </div>
        </div>

        <div id="customersTab" class="tabContent">
            <div style="position: relative;">
                <i data-lucide="search" class="w-4 h-4 absolute left-3 top-3 text-slate-400"></i>
                <input
                    type="text"
                    id="searchInput"
                    placeholder="Search Customers..."
                    style="padding-left: 36px;" />
                
                <div class="px-3 py-2 border-b border-slate-100">
                    <label class="filter-label">
                        <input type="checkbox" id="filterActiveTasksCheckbox">
                        Active Tasks Only
                    </label>
                </div>
                
                <!-- Task loading indicator -->
                <div id="tasksLoadingBar" class="hidden absolute bottom-0 left-0 w-full h-0.5 bg-gray-100 overflow-hidden">
                    <div class="h-full bg-primary-500 animate-[loading_1.5s_infinite_linear]" style="width: 30%; position: absolute;"></div>
                </div>
            </div>

            <!-- Filter by customer status checkboxes -->
            <div class="tab-section">
                <label class="section-label">Customer Status</label>
                <div id="statusFilterCheckboxes" class="filter-container custom-scrollbar">
                </div>
                <div class="filter-buttons">
                    <button id="selectAllStatusBtn" class="filter-button-small">All</button>
                    <button id="clearAllStatusBtn" class="filter-button-small">None</button>
                </div>
            </div>

            <!-- Filter by task status checkboxes -->
            <div class="tab-section">
                <label class="section-label">Task Status</label>
                <div id="taskStatusFilterCheckboxes" class="filter-container custom-scrollbar">
                </div>
                <div class="filter-buttons">
                    <button id="selectAllTaskStatusBtn" class="filter-button-small">All</button>
                    <button id="clearAllTaskStatusBtn" class="filter-button-small">None</button>
                </div>
            </div>

            <!-- Hide unlinked customers checkbox -->
            <div class="customer-filter-section">
                <label class="filter-label">
                    <input type="checkbox" id="hideUnlinkedCustomersCheckbox">
                    Hide Unlinked Customers
                </label>
            </div>

            <div id="customerList" class="custom-scrollbar"></div>
        </div>

        <div id="tasksTab" class="tabContent">
            <div style="position: relative; margin-bottom: 12px;">
                <i data-lucide="search" class="w-4 h-4 absolute left-3 top-3 text-slate-400"></i>
                <input
                    type="text"
                    id="taskSearchInput"
                    placeholder="Search Tasks (ID, Title, Customer)..."
                    style="padding-left: 36px; width: 100%;" />
            </div>

            <div class="tab-section">
                <div class="flex justify-between items-center mb-2">
                    <label class="section-label" style="margin-bottom: 0;">Loaded Tasks</label>
                    <span id="taskCountBadge" class="text-[10px] px-2 py-0.5 rounded-full bg-primary-100 text-primary-600 font-bold">0</span>
                </div>
                <div class="flex items-center gap-2 mb-3">
                    <button id="importTasksBtn" class="filter-button-small">Import Spreadsheet</button>
                    <select id="tasksFileSelect" class="filter-select" style="display:none; max-width: 60%;"></select>
                    <button id="refreshImportedTasksBtn" class="filter-button-small" title="Refresh from last imported file">Refresh</button>
                </div>
                <div id="tasksList" class="custom-scrollbar" style="max-height: calc(100vh - 250px); overflow-y: auto;"></div>
            </div>
        </div>

        <div id="playgroundTab" class="tabContent">
            <div class="tab-section">
                <label class="section-label">Simulation Controls</label>
                <div class="filter-buttons" style="flex-direction: column;">
                    <button id="startSimBtn" class="filter-button" style="width: 100%; margin-bottom: 8px;">
                        <i data-lucide="play" class="w-4 h-4 inline-block mr-2"></i>
                        Start Simulation
                    </button>
                    <button id="stopSimBtn" class="filter-button" disabled style="width: 100%; margin-bottom: 8px;">
                        <i data-lucide="square" class="w-4 h-4 inline-block mr-2"></i>
                        Stop Simulation
                    </button>
                    <button id="addAgentBtn" class="filter-button" style="width: 100%;">
                        <i data-lucide="user-plus" class="w-4 h-4 inline-block mr-2"></i>
                        Add Random Agent
                    </button>
                </div>
            </div>

            <div class="tab-section">
                <label class="section-label">Simulation Time</label>
                <div class="flex items-center justify-center p-3 bg-slate-50 rounded-lg border border-slate-200 mb-2">
                    <i data-lucide="clock" class="w-4 h-4 text-primary-500 mr-2"></i>
                    <span id="simClockDisplay" class="text-lg font-mono font-bold text-slate-700">00:00:00</span>
                </div>
            </div>

            <div class="tab-section">
                <label class="section-label">Movement Speed</label>
                <div class="px-2">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-[10px] text-slate-500">Travel Speed</span>
                        <span id="speedValueDisplay" class="text-[10px] font-bold text-primary-600">1.0x</span>
                    </div>
                    <input type="range" id="simSpeedSlider" min="0.1" max="50" step="0.5" value="1" style="width: 100%; height: 4px; background: #e2e8f0; border-radius: 2px; cursor: pointer;">
                </div>
            </div>

            <div class="tab-section">
                <label class="section-label">Work Completion Speed</label>
                <div class="px-2">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-[10px] text-slate-500">Work Speed</span>
                        <span id="workSpeedValueDisplay" class="text-[10px] font-bold text-primary-600">1.0x</span>
                    </div>
                    <input type="range" id="simWorkSpeedSlider" min="1" max="100" step="1" value="1" style="width: 100%; height: 4px; background: #e2e8f0; border-radius: 2px; cursor: pointer;">
                    <p class="text-[9px] text-slate-400 mt-1 italic text-center">Accelerates technician "on-site" work time</p>
                </div>
            </div>

            <div class="tab-section">
                <label class="section-label">Scenarios</label>
                <div class="filter-buttons" style="flex-direction: column; gap: 8px;">
                    <button id="simRandomTasksBtn" class="filter-button-small">
                        <i data-lucide="list-checks" class="w-3 h-3 inline-block mr-1"></i>
                        Random Tasks
                    </button>
                    <button id="optimizeRoutesBtn" class="filter-button-small">
                        <i data-lucide="route" class="w-3 h-3 inline-block mr-1"></i>
                        Optimize Routes
                    </button>
                    <button id="simTowerOutageBtn" class="filter-button-small">
                        <i data-lucide="zap-off" class="w-3 h-3 inline-block mr-1"></i>
                        Tower Outage
                    </button>
                    <button id="simStormBtn" class="filter-button-small">
                        <i data-lucide="cloud-lightning" class="w-3 h-3 inline-block mr-1"></i>
                        Storm Event
                    </button>
                    <button id="clearScenariosBtn" class="filter-button-small">
                        <i data-lucide="trash-2" class="w-3 h-3 inline-block mr-1"></i>
                        Clear All
                    </button>
                </div>
            </div>

            <div class="tab-section">
                <label class="section-label">Visualizations</label>
                <div class="filter-label" style="margin-bottom: 8px;">
                    <input type="checkbox" id="toggleHeatmapCheckbox">
                    Coverage Heatmap
                </div>
            </div>

            <div class="tab-section">
                <label class="section-label">Nagios Integration</label>
                <div class="filter-label" style="margin-bottom: 8px;">
                    <input type="checkbox" id="toggleNagiosCheckbox" checked>
                    Enable Nagios Fetching
                </div>
            </div>

            <div class="tab-section">
                <label class="section-label">Mock Notifications</label>
                <button id="testNotifyBtn" class="filter-button-small" style="width: 100%;">
                    <i data-lucide="bell" class="w-3 h-3 inline-block mr-1"></i>
                    Trigger Test Alert
                </button>
            </div>
        </div>

        <div id="servicesTab" class="tabContent">
            <div class="tab-section">
                <label class="section-label">External Services</label>
                <div style="display:flex;flex-direction:column;gap:8px;">
                    <label class="filter-label"><input type="checkbox" id="serviceNagiosCheckbox"> Enable Nagios</label>
                    <label class="filter-label"><input type="checkbox" id="serviceSplynxCheckbox"> Enable Splynx Tasks</label>
                    <label class="filter-label"><input type="checkbox" id="serviceTrackerCheckbox"> Enable Trackers (Traccar)</label>
                    <label class="filter-label"><input type="checkbox" id="serviceWeatherCheckbox"> Enable Weather</label>
                </div>
            </div>
        </div>

        <div id="dragBar"></div>
    </div>

    <div id="map"></div>

    <div id="globalClock" style="position: fixed; right: 96px; bottom: 16px; background: rgba(15,23,42,0.8); color: white; padding: 8px 12px; border-radius: 8px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size: 12px; z-index: 1000; border: 1px solid rgba(255,255,255,0.12);">--:--:--</div>

    <script>
      (function(){
        var el = document.getElementById('globalClock');
        if(!el) return;
        function pad(n){ return String(n).padStart(2,'0'); }
        function tick(){
          var d = new Date();
          el.textContent = pad(d.getHours())+':' + pad(d.getMinutes()) + ':' + pad(d.getSeconds());
        }
        tick();
        setInterval(tick, 1000);
      })();
    </script>

    <button id="centerOfficeBtn" title="Center on Office">
        <i data-lucide="home"></i>
    </button>

    <div id="rightSidebar" class="custom-scrollbar collapsed">
        <div id="rightSidebarHeader" class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-primary-500/10 p-2 rounded-lg text-primary-600">
                    <i data-lucide="users" class="w-5 h-5"></i>
                </div>
                <span class="font-bold text-slate-800">Team Management</span>
            </div>
            <div class="flex items-center gap-2">
                <button id="openTaskDashBtn" class="p-2 text-slate-400 hover:text-primary-500 transition-colors" title="Open Task Management Dashboard">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                </button>
                <button id="clearTeamBtn" class="p-2 text-gray-400 hover:text-red-500 transition-colors" title="Clear All Team Members">
                    <i data-lucide="user-minus" class="w-5 h-5"></i>
                </button>
            </div>
        </div>

        <div id="teamManagementContent" class="flex flex-col flex-1 min-h-0">
            <div class="p-4">
                <div class="relative inline-block w-full" id="addMemberContainer">
                    <button id="addMemberBtn" class="filter-button w-full flex items-center justify-center gap-2">
                        <i data-lucide="user-plus" class="w-4 h-4"></i>
                        Add Member
                    </button>
                    <div id="adminDropdown" class="absolute left-0 mt-2 w-full bg-white border border-gray-200 rounded-xl shadow-xl z-50 hidden max-h-60 overflow-y-auto custom-scrollbar">
                        <!-- Admins will be listed here -->
                    </div>
                </div>
            </div>

            <div id="teamMemberList" class="flex-1 overflow-y-auto p-4 space-y-4">
                <!-- Team members will be listed here -->
            </div>
        </div>

        <div id="agentList" class="flex-1 overflow-y-auto custom-scrollbar hidden">
            <!-- Agent list will be populated here -->
        </div>

        <div id="memberDetails" class="hidden absolute inset-0 bg-white z-[60] flex flex-col">
            <div class="p-4 border-bottom flex items-center justify-between">
                <button id="backToTeamBtn" class="p-2 hover:bg-gray-100 rounded-lg">
                    <i data-lucide="chevron-left" class="w-5 h-5"></i>
                </button>
                <span id="detailMemberName" class="font-bold text-lg">Member Name</span>
                <div class="w-9"></div> <!-- Spacer -->
            </div>
            
            <div id="detailTabs" class="flex border-b">
                <button class="flex-1 py-3 font-semibold text-sm border-b-2 border-primary-500 text-primary-600 detail-tab-btn" data-tab="info">Info</button>
                <button class="flex-1 py-3 font-semibold text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700 detail-tab-btn" data-tab="tasks">Tasks</button>
                <button class="flex-1 py-3 font-semibold text-sm border-b-2 border-transparent text-gray-300 cursor-not-allowed detail-tab-btn" data-tab="performance" disabled>Performance</button>
            </div>

            <div id="detailContent" class="flex-1 p-4 overflow-y-auto">
                <div id="autoAssignContainer" class="mb-6 hidden bg-purple-50 p-4 rounded-xl border border-purple-100">
                    <div class="flex gap-2">
                        <button id="toggleAutoAssignUI" class="filter-button flex-1 flex items-center justify-center gap-2 bg-purple-600 text-white hover:bg-purple-700">
                            <i data-lucide="zap" class="w-4 h-4"></i>
                            Auto Assign
                        </button>
                        <button id="toggleBulkSelect" class="p-2 bg-white border border-purple-200 text-purple-600 rounded-lg hover:bg-purple-50 transition-colors" title="Bulk Select on Map">
                            <i data-lucide="mouse-pointer-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div id="bulkSelectHint" class="hidden mt-2 text-[10px] text-purple-500 font-bold text-center uppercase tracking-tighter">
                        Mode: Click customers on map to select
                    </div>
                    <div id="autoAssignUI" class="hidden mt-4 space-y-3">
                        <label class="text-xs font-bold text-purple-600 uppercase tracking-wider">Task IDs (comma separated)</label>
                        <textarea id="autoAssignInput" class="w-full p-3 rounded-lg border border-purple-200 focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none text-sm min-h-[80px]" placeholder="e.g. 1234, 5678, 9012"></textarea>
                        <div class="flex gap-2">
                            <button id="confirmAutoAssign" class="flex-1 py-2 bg-purple-600 text-white rounded-lg font-bold text-sm hover:bg-purple-700 transition-colors">Apply</button>
                            <button id="cancelAutoAssign" class="px-4 py-2 bg-white border border-purple-200 text-purple-600 rounded-lg font-bold text-sm hover:bg-purple-50 transition-colors">Cancel</button>
                        </div>
                    </div>
                </div>
                <!-- Tab content for member details -->
                <div id="memberInfoContent" class="detail-tab-content">
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="p-4 bg-gray-50 rounded-xl border border-gray-100">
                                <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">Assigned Tasks</label>
                                <div id="infoTaskCount" class="text-2xl font-bold text-slate-800 mt-1">0</div>
                            </div>
                            <div class="p-4 bg-gray-50 rounded-xl border border-gray-100">
                                <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">Vehicle</label>
                                <div id="infoVehicle" class="text-lg font-bold text-primary-600 mt-1">None</div>
                            </div>
                        </div>
                        <div class="p-4 bg-gray-50 rounded-xl border border-gray-100">
                            <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">Status</label>
                            <div class="text-green-500 font-semibold flex items-center gap-2 mt-1">
                                <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                                Active
                            </div>
                        </div>
                    </div>
                </div>
                <div id="memberTasksContent" class="detail-tab-content hidden">
                    <div id="memberTaskList" class="space-y-3">
                        <!-- Tasks for member will be listed here -->
                    </div>
                </div>
                <div id="memberPerformanceContent" class="detail-tab-content hidden">Performance View</div>
            </div>
        </div>

        <div id="rightDragBar"></div>
    </div>
    <button id="rightToggleBtn"></button>
    <div id="notificationContainer" style="position: absolute; bottom: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; pointer-events: none;"></div>

    <!-- Agent Edit Modal -->
    <div id="editAgentModal" class="edit-agent-modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">Edit Agent</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Agent Name</label>
                <input type="text" id="editAgentName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Seniority</label>
                <select id="editAgentSeniority" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none">
                    <option value="Junior">Junior</option>
                    <option value="Intermediate">Intermediate</option>
                    <option value="Senior">Senior</option>
                    <option value="Lead">Lead</option>
                </select>
            </div>
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Agent Color</label>
                <div class="flex items-center gap-3">
                    <div id="currentColorDisplay" class="w-10 h-10 rounded-lg border border-gray-200 shadow-sm"></div>
                    <button id="openPaletteBtn" class="filter-button py-2 px-4 text-xs">Change Color</button>
                </div>
            </div>
            <div class="flex gap-3">
                <button id="cancelEditAgentBtn" class="flex-1 py-2 bg-gray-100 text-gray-700 rounded-lg font-semibold hover:bg-gray-200">Cancel</button>
                <button id="saveEditAgentBtn" class="flex-1 py-2 bg-primary-500 text-white rounded-lg font-semibold hover:bg-primary-600">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Color Palette Popup -->
    <div id="colorPalettePopup" class="color-palette-popup">
        <div class="flex justify-between items-center mb-2">
            <span class="text-xs font-bold uppercase tracking-wider text-slate-500">Pick a Color</span>
            <button id="closePaletteBtn" class="text-slate-400 hover:text-slate-600">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
        </div>
        <div id="colorGrid" class="color-grid"></div>
    </div>

    <!-- Task Management Dashboard -->
    <div id="taskDashboard" class="fixed inset-0 bg-slate-50/95 backdrop-blur-xl z-[3000] hidden flex flex-col animate__animated">
        <div class="bg-gradient-to-r from-slate-900 to-slate-800 p-6 flex justify-between items-center shadow-2xl border-b border-white/10">
            <div class="flex items-center gap-6">
                <div class="bg-primary-600 p-3.5 rounded-2xl text-white shadow-xl shadow-primary-500/20 animate-pulse-soft">
                    <i data-lucide="layout-dashboard" class="w-8 h-8"></i>
                </div>
                <div>
                    <h2 class="text-2xl font-black text-white tracking-tighter uppercase">ISP Command Center</h2>
                    <div class="flex items-center gap-3 mt-1.5 opacity-80">
                        <span class="flex items-center gap-2 text-[10px] font-black text-emerald-400 bg-emerald-400/10 px-2.5 py-1 rounded-lg border border-emerald-400/20 uppercase tracking-widest">
                            <span class="w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.8)]"></span>
                            Systems Nominal
                        </span>
                        <span class="text-[10px] text-slate-400 font-black uppercase tracking-[0.2em]">Operational Intelligence & Control</span>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-6">
                <button id="toggleStrategyBtn" class="p-3.5 bg-white/5 text-slate-400 rounded-2xl hover:bg-primary-600 hover:text-white transition-all shadow-xl border border-white/10 group" title="Toggle Strategy Panel">
                    <i data-lucide="settings-2" class="w-6 h-6"></i>
                </button>
                <div id="simClockDisplay" class="hidden md:flex items-center gap-4 px-6 py-2.5 bg-white/5 backdrop-blur-xl rounded-2xl font-mono font-black text-primary-400 border border-white/10 shadow-inner text-xl tracking-widest">
                    <i data-lucide="clock" class="w-5 h-5 text-primary-500/50"></i>
                    00:00:00
                </div>
                <button id="closeTaskDashBtn" class="p-4 bg-white/5 text-slate-400 rounded-2xl hover:bg-red-500 hover:text-white transition-all shadow-xl border border-white/10 group">
                    <i data-lucide="x" class="w-7 h-7 group-hover:rotate-90 transition-transform"></i>
                </button>
            </div>
        </div>
        
        <div class="flex-1 overflow-hidden flex p-6 gap-6 bg-slate-100/30">
            <!-- Left: Priority Factors & Configuration -->
            <div id="strategyPanel" class="w-80 dashboard-card p-6 overflow-y-auto custom-scrollbar transition-all duration-500 origin-left">
                <h3 class="font-black text-slate-800 mb-6 flex items-center gap-3 text-lg uppercase tracking-tight">
                    <div class="p-2 bg-primary-100 text-primary-600 rounded-lg">
                        <i data-lucide="settings-2" class="w-5 h-5"></i>
                    </div>
                    Strategy
                </h3>
                
                <div class="space-y-8">
                    <div class="priority-factor-item">
                        <div class="flex justify-between items-center mb-3">
                            <label class="text-xs font-black text-slate-500 uppercase tracking-widest">Distance</label>
                            <span class="text-xs font-black text-primary-600 factor-value bg-primary-50 px-2 py-1 rounded-md">1.0x</span>
                        </div>
                        <input type="range" class="factor-slider w-full" data-factor="distance" min="0.1" max="5.0" step="0.1" value="1.0">
                    </div>
                    
                    <div class="priority-factor-item">
                        <div class="flex justify-between items-center mb-3">
                            <label class="text-xs font-black text-slate-500 uppercase tracking-widest">Ticket Age</label>
                            <span class="text-xs font-black text-primary-600 factor-value bg-primary-50 px-2 py-1 rounded-md">1.5x</span>
                        </div>
                        <input type="range" class="factor-slider w-full" data-factor="age" min="0.1" max="5.0" step="0.1" value="1.5">
                    </div>
                    
                    <div class="priority-factor-item">
                        <div class="flex justify-between items-center mb-3">
                            <label class="text-xs font-black text-slate-500 uppercase tracking-widest">Business</label>
                            <span class="text-xs font-black text-primary-600 factor-value bg-primary-50 px-2 py-1 rounded-md">2.0x</span>
                        </div>
                        <input type="range" class="factor-slider w-full" data-factor="business" min="1.0" max="10.0" step="0.5" value="2.0">
                    </div>

                    <div class="priority-factor-item pt-6 border-t border-slate-100">
                        <div class="flex justify-between items-center mb-3">
                            <label class="text-xs font-black text-indigo-800 uppercase tracking-widest">Work Speed</label>
                            <span id="workSpeedValue" class="text-xs font-black text-indigo-600 bg-indigo-50 px-2 py-1 rounded-md">1.0x</span>
                        </div>
                        <input type="range" id="workSpeedSlider" class="factor-slider w-full accent-indigo-500" min="1" max="100" step="1" value="1">
                        <p class="text-[9px] text-slate-400 mt-2 font-bold italic uppercase opacity-60">Testing: Speed up completion</p>
                    </div>
                    
                    <div class="pt-4">
                        <button id="shortenWorkTimeBtn" class="w-full py-2.5 bg-indigo-50 text-indigo-600 rounded-xl font-black text-[10px] uppercase tracking-widest border border-indigo-100 hover:bg-indigo-600 hover:text-white transition-all shadow-sm">
                            Finish All Current Tasks
                        </button>
                    </div>
                </div>

                <div class="mt-10 pt-8 border-t border-slate-100">
                    <label class="text-xs font-black text-slate-500 uppercase tracking-widest block mb-3">SLA Indicators</label>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Amber After</span>
                            <div class="flex items-center gap-2">
                                <input type="number" id="slaAmberHoursInput" min="1" max="168" class="w-16 bg-slate-100/50 border border-slate-200 rounded-lg px-2 py-1 text-xs font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500" value="8">
                                <span class="text-[10px] text-slate-400 font-black uppercase">hrs</span>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Red After</span>
                            <div class="flex items-center gap-2">
                                <input type="number" id="slaRedHoursInput" min="1" max="168" class="w-16 bg-slate-100/50 border border-slate-200 rounded-lg px-2 py-1 text-xs font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500" value="24">
                                <span class="text-[10px] text-slate-400 font-black uppercase">hrs</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 mt-2">
                            <span class="sla-dot sla-green" title="Low Risk"></span>
                            <span class="sla-dot sla-amber" title="Approaching SLA"></span>
                            <span class="sla-dot sla-red" title="SLA Risk"></span>
                            <button id="slaResetBtn" class="ml-auto filter-button-small">Reset</button>
                        </div>
                    </div>
                </div>

                <div class="mt-10 pt-8 border-t border-slate-100">
                    <button id="applyOptimizationBtn" class="w-full py-4 bg-primary-600 text-white rounded-2xl font-black shadow-xl shadow-primary-200 hover:bg-primary-700 hover:shadow-primary-300 transition-all flex items-center justify-center gap-3 uppercase tracking-tighter text-sm">
                        <i data-lucide="zap" class="w-5 h-5"></i>
                        Recalculate Routes
                    </button>
                </div>
            </div>

            <!-- Main Dashboard Area -->
            <div class="flex-1 overflow-y-auto custom-scrollbar flex flex-col">
                <!-- ISP Heartbeat Strip -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 shrink-0">
                    <div class="dashboard-card heartbeat-stat p-6 border-l-4 border-l-emerald-500">
                        <div class="flex items-center gap-5">
                            <div class="bg-emerald-500/10 p-4 rounded-2xl text-emerald-600">
                                <i data-lucide="activity" class="w-7 h-7"></i>
                            </div>
                            <div>
                                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Network Health</p>
                                <h4 id="hbNetworkHealth" class="text-3xl font-black text-slate-800 tracking-tight">0%</h4>
                            </div>
                        </div>
                    </div>
                    <div class="dashboard-card heartbeat-stat p-6 border-l-4 border-l-primary-500">
                        <div class="flex items-center gap-5">
                            <div class="bg-primary-500/10 p-4 rounded-2xl text-primary-600">
                                <i data-lucide="ticket" class="w-7 h-7"></i>
                            </div>
                            <div>
                                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Open Tickets</p>
                                <h4 id="hbOpenTickets" class="text-3xl font-black text-slate-800 tracking-tight">0</h4>
                                <div id="hbOpenTicketsTrend" class="text-[10px] font-black text-slate-400 mt-0.5 flex items-center gap-1"></div>
                            </div>
                        </div>
                    </div>
                    <div class="dashboard-card heartbeat-stat p-6 border-l-4 border-l-red-500">
                        <div class="flex items-center gap-5">
                            <div class="bg-red-500/10 p-4 rounded-2xl text-red-600">
                                <i data-lucide="alert-circle" class="w-7 h-7"></i>
                            </div>
                            <div>
                                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Critical Priority</p>
                                <h4 id="hbCriticalTasks" class="text-3xl font-black text-slate-800 tracking-tight">0</h4>
                                <div id="hbCriticalTasksTrend" class="text-[10px] font-black text-slate-400 mt-0.5 flex items-center gap-1"></div>
                            </div>
                        </div>
                    </div>
                    <div class="dashboard-card heartbeat-stat p-6 border-l-4 border-l-amber-500">
                        <div class="flex items-center gap-5">
                            <div class="bg-amber-500/10 p-4 rounded-2xl text-amber-600">
                                <i data-lucide="truck" class="w-7 h-7"></i>
                            </div>
                            <div>
                                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Active Techs</p>
                                <h4 id="hbActiveTechs" class="text-3xl font-black text-slate-800 tracking-tight">0</h4>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex flex-1 gap-8 pb-10 min-h-0">
                    <!-- Open Tasks Overview (NOW ON LEFT) -->
                    <div class="flex-1 dashboard-card overflow-hidden flex flex-col min-h-[500px] min-w-0">
                        <div class="p-6 border-b border-slate-100 flex flex-col gap-4 bg-white/50 backdrop-blur-sm">
                            <div class="flex justify-between items-center">
                                <h3 class="font-black text-slate-800 flex items-center gap-3 uppercase tracking-tight">
                                    <div class="p-2 bg-primary-100 text-primary-500 rounded-lg">
                                        <i data-lucide="clipboard-list" class="w-5 h-5"></i>
                                    </div>
                                    Priority Queue
                                </h3>
                                <div class="flex items-center gap-4">
                                    <!-- Adjustable Grid Columns -->
                                    <div class="flex items-center gap-2 bg-slate-100 rounded-xl px-3 py-1.5 border border-slate-200">
                                        <label for="dashGridCols" class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Cols</label>
                                        <input type="range" id="dashGridCols" min="1" max="4" value="2" class="w-20 h-1.5 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-primary-600">
                                        <span id="dashGridColsVal" class="text-[10px] font-black text-primary-600 w-4 text-center">2</span>
                                    </div>
                                    
                                    <button id="selectAllTasksBtn" class="p-2 bg-slate-100 text-slate-500 rounded-xl hover:bg-primary-100 hover:text-primary-600 transition-all" title="Select All Visible">
                                        <i data-lucide="check-square" class="w-4 h-4"></i>
                                    </button>
                                    
                                    <button id="dashAddTasksBtn" class="p-2 bg-primary-600 text-white rounded-xl hover:bg-primary-700 transition-all shadow-md shadow-primary-100" title="Add Random Tasks">
                                        <i data-lucide="list-plus" class="w-4 h-4"></i>
                                    </button>
                                    <div class="flex items-center gap-1 bg-slate-100 rounded-xl px-1.5 py-1 border border-slate-200" id="densityToggle" title="Card Density">
                                        <button id="densityComfortBtn" class="px-2 py-1 text-[10px] font-black rounded-lg">Comfort</button>
                                        <button id="densityCompactBtn" class="px-2 py-1 text-[10px] font-black rounded-lg">Compact</button>
                                    </div>
                                    <span id="dashTaskCount" class="text-[10px] font-black bg-slate-100 text-slate-500 px-3 py-1.5 rounded-full uppercase tracking-widest">0 Tasks</span>
                                </div>
                            </div>
                            <div class="flex gap-3">
                                <div class="relative flex-1">
                                    <i data-lucide="search" class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                    <input type="text" id="dashTaskSearch" placeholder="Search tasks..." class="w-full pl-10 pr-4 py-2 bg-slate-100/50 border border-slate-200 rounded-xl text-xs focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500 transition-all">
                                </div>
                                <div id="dashFiltersBar" class="flex flex-wrap items-center gap-2">
                                    <div class="flex items-center gap-2 bg-slate-100/50 border border-slate-200 rounded-xl px-2 py-1.5">
                                        <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Priority</span>
                                        <label class="text-[10px] font-bold text-slate-600 flex items-center gap-1"><input type="checkbox" id="fPriCritical" class="accent-red-500" checked> Critical</label>
                                        <label class="text-[10px] font-bold text-slate-600 flex items-center gap-1"><input type="checkbox" id="fPriHigh" class="accent-orange-500" checked> High</label>
                                        <label class="text-[10px] font-bold text-slate-600 flex items-center gap-1"><input type="checkbox" id="fPriMedium" class="accent-blue-500" checked> Medium</label>
                                        <label class="text-[10px] font-bold text-slate-600 flex items-center gap-1"><input type="checkbox" id="fPriLow" class="accent-slate-500" checked> Low</label>
                                    </div>
                                    <select id="dashTaskStatusFilter" class="bg-slate-100/50 border border-slate-200 rounded-xl px-3 py-2 text-[10px] font-black text-slate-600 focus:outline-none focus:ring-2 focus:ring-primary-500/20 min-w-[140px]">
                                        <option value="all">All Statuses</option>
                                    </select>
                                    <select id="dashTaskCustomerFilter" class="bg-slate-100/50 border border-slate-200 rounded-xl px-3 py-2 text-[10px] font-black text-slate-600 focus:outline-none focus:ring-2 focus:ring-primary-500/20 min-w-[160px]">
                                        <option value="all">All Customers</option>
                                    </select>
                                    <select id="dashTaskAgeFilter" class="bg-slate-100/50 border border-slate-200 rounded-xl px-3 py-2 text-[10px] font-black text-slate-600 focus:outline-none focus:ring-2 focus:ring-primary-500/20">
                                        <option value="all">Any Age</option>
                                        <option value="today">Today</option>
                                        <option value="24h">24h</option>
                                        <option value="48h">48h+</option>
                                    </select>
                                    <label class="bg-slate-100/50 border border-slate-200 rounded-xl px-3 py-2 text-[10px] font-black text-slate-600 flex items-center gap-2">
                                        <input type="checkbox" id="dashUnassignedOnly" class="accent-primary-600">
                                        Unassigned Only
                                    </label>
                                    <select id="dashSortPreset" class="bg-white border border-slate-200 rounded-xl px-3 py-2 text-[10px] font-black text-slate-700 focus:outline-none focus:ring-2 focus:ring-primary-500/20">
                                        <option value="urgent">Urgent First</option>
                                        <option value="oldest">Oldest First</option>
                                        <option value="unassigned">Unassigned</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Bulk Assignment Action Bar -->
                            <div id="bulkAssignmentBar" class="hidden animate__animated animate__fadeInUp bg-primary-50 border border-primary-100 rounded-xl p-3 flex justify-between items-center">
                                <span class="text-[10px] font-black text-primary-700 uppercase tracking-widest">
                                    <span id="selectedTaskCount">0</span> Tasks Selected for <span id="targetTechName">...</span>
                                </span>
                                <div class="flex gap-2">
                                    <button id="confirmBulkAssignBtn" class="px-4 py-1.5 bg-primary-600 text-white text-[10px] font-black uppercase rounded-lg hover:bg-primary-700 transition-all shadow-md">Confirm</button>
                                    <button id="cancelBulkAssignBtn" class="px-4 py-1.5 bg-white text-slate-500 text-[10px] font-black uppercase rounded-lg border border-slate-200 hover:bg-slate-50 transition-all">Cancel</button>
                                </div>
                            </div>
                        </div>
                        <div id="dashTaskList" class="p-6 flex-1 overflow-y-auto custom-scrollbar">
                            <!-- Populated via JS -->
                        </div>
                    </div>

                    <!-- Active Agents & Queues (NOW ON RIGHT) -->
                    <div class="w-96 dashboard-card overflow-hidden flex flex-col min-h-[500px]">
                        <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-white/50 backdrop-blur-sm">
                            <h3 class="font-black text-slate-800 flex items-center gap-3 uppercase tracking-tight">
                                <div class="p-2 bg-primary-100 text-primary-500 rounded-lg">
                                    <i data-lucide="users" class="w-5 h-5"></i>
                                </div>
                                Team
                            </h3>
                            <div class="flex items-center gap-3">
                                <button id="dashAddAgentBtn" class="p-2 bg-primary-600 text-white rounded-xl hover:bg-primary-700 transition-all shadow-md shadow-primary-100" title="Add Random Agent">
                                    <i data-lucide="user-plus" class="w-4 h-4"></i>
                                </button>
                                <span id="dashAgentCount" class="text-[10px] font-black bg-slate-100 text-slate-500 px-3 py-1.5 rounded-full uppercase tracking-widest">0</span>
                            </div>
                        </div>
                        <div id="dashAgentList" class="p-6 space-y-5 flex-1 overflow-y-auto custom-scrollbar">
                            <!-- Populated via JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CHANGED: Your script must load BEFORE Google Maps so initMap exists -->
<script defer src="state.js"></script>
<script defer src="Marker Scripts/Markers.js"></script>
<script defer src="Marker Scripts/Simulation.js"></script>
<script defer src="User Interface/Sidebar.js"></script>
<script defer src="User Interface/TeamSidebar.js"></script>
<!-- FIXED: Added missing Searchbar.js script -->
<script defer src="User Interface/Searchbar.js"></script>
<script defer src="User Interface/OperationalDashboard.js"></script>
<script defer src="src/weather/ClockManager.js"></script>
<script defer src="src/weather/WeatherService.js"></script>
<script defer src="src/weather/WeatherOverlay.js"></script>

<script>
    // Initialize Lucide icons
    document.addEventListener('DOMContentLoaded', () => {
        if (window.lucide) {
            window.lucide.createIcons();
        }
    });
</script>

<!-- CHANGED: added defer to guarantee DOM readiness and callback safety -->
<script>
    async function loadGoogleMaps() {
        try {
            const response = await fetch('/api/config');
            const config = await response.json();
            if (!window.AppState) window.AppState = {};
            window.AppState.config = config;
            window.dispatchEvent(new CustomEvent('configLoaded', { detail: config }));
            if (!config.googleMapsKey) {
                console.error('Google Maps API key not found in server configuration');
                return;
            }
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${config.googleMapsKey}&callback=initMap&libraries=geometry`;
            script.defer = true;
            document.body.appendChild(script);
        } catch (error) {
            console.error('Failed to load Google Maps configuration:', error);
        }
    }
    loadGoogleMaps();
</script>

<script>
(function(){
  document.addEventListener('DOMContentLoaded', async function(){
    let cfg = window.AppConfig;
    if (!cfg) {
      try {
        const r = await fetch('/api/config');
        cfg = await r.json();
        window.AppConfig = cfg;
      } catch (_){ cfg = {}; }
    }
    window.addEventListener('configLoaded', function(e){
      if (!window.AppConfig && e && e.detail && e.detail.openWeatherKey) {
        window.AppConfig = e.detail;
      }
    });

    const importBtn = document.getElementById('importTasksBtn');
    const selectEl = document.getElementById('tasksFileSelect');
    const refreshBtn = document.getElementById('refreshImportedTasksBtn');

    async function populateFiles() {
      try {
        const r = await fetch('/api/data/files');
        const j = await r.json();
        const files = Array.isArray(j.files) ? j.files : [];
        selectEl.innerHTML = '';
        const opt0 = document.createElement('option');
        opt0.value = '';
        opt0.textContent = 'Select a file...';
        selectEl.appendChild(opt0);
        files.forEach(f => { const o = document.createElement('option'); o.value = f; o.textContent = f; selectEl.appendChild(o); });
        if (files.length > 0) selectEl.style.display = '';
        else {
          selectEl.style.display = 'none';
          alert('No CSV/XLSX files found in Data');
        }
      } catch(e) {
        alert('Failed to load files');
      }
    }

    if (importBtn) {
      importBtn.addEventListener('click', async function(){
        await populateFiles();
        if (selectEl) selectEl.focus();
      });
    }

    if (selectEl) {
      selectEl.addEventListener('change', async function(){
        const f = selectEl.value;
        if (!f) return;
        try {
          const r = await fetch('/api/tasks/import', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ file: f }) });
          if (!r.ok) {
            const e = await r.json().catch(()=>({}));
            alert(e && e.error ? e.error : 'Import failed');
            return;
          }
          await fetchTasks();
        } catch(e) {
          alert('Import failed');
        } finally {
          selectEl.style.display = 'none';
          selectEl.value = '';
        }
      });
    }

    if (refreshBtn) {
      refreshBtn.addEventListener('click', async function(){
        try {
          const r = await fetch('/api/tasks/reload');
          if (!r.ok) {
            await fetchTasks();
            return;
          }
          await fetchTasks();
        } catch(_){ await fetchTasks(); }
      });
    }

        // Service toggles: wire UI to backend toggle endpoints
        async function setupServiceToggles(){
            try {
                const r = await fetch('/api/config');
                const cfg = await r.json();
                const adminToken = cfg.adminToken || '';
                const nagiosCb = document.getElementById('serviceNagiosCheckbox');
                const splynxCb = document.getElementById('serviceSplynxCheckbox');
                const trackerCb = document.getElementById('serviceTrackerCheckbox');
                const weatherCb = document.getElementById('serviceWeatherCheckbox');
                if (nagiosCb) nagiosCb.checked = !!cfg.enableNagios;
                if (splynxCb) splynxCb.checked = !!cfg.enableSplynx;
                if (trackerCb) trackerCb.checked = !!cfg.enableTraccar;
                if (weatherCb) weatherCb.checked = !!cfg.enableWeather;

                async function postToggle(path, enabled){
                    try {
                        const res = await fetch(path, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Admin-Token': adminToken }, body: JSON.stringify({ enabled }) });
                        return res.ok;
                    } catch (e) { return false; }
                }

                if (nagiosCb) nagiosCb.addEventListener('change', async ()=>{ const ok = await postToggle('/api/nagios/toggle', nagiosCb.checked); if (!ok) alert('Failed to update Nagios'); });
                if (splynxCb) splynxCb.addEventListener('change', async ()=>{ const ok = await postToggle('/api/splynx/toggle', splynxCb.checked); if (!ok) alert('Failed to update Splynx'); });
                if (trackerCb) trackerCb.addEventListener('change', async ()=>{ 
                    const ok = await postToggle('/api/tracker/toggle', trackerCb.checked); 
                    if (!ok) {
                        alert('Failed to update Tracker');
                        return;
                    }
                    // Update client state to start/stop polling and websocket
                    window.AppConfig = window.AppConfig || {};
                    window.AppConfig.enableTraccar = !!trackerCb.checked;
                    if (typeof AppState !== 'undefined') {
                        AppState.trackerRefresh = AppState.trackerRefresh || {};
                        AppState.trackerRefresh.enabled = !!trackerCb.checked;
                        if (trackerCb.checked) {
                            if (typeof connectTrackerWebSocket === 'function') connectTrackerWebSocket();
                            if (!AppState.trackerRefresh.wsConnected && typeof startTrackerRefreshLoop === 'function') startTrackerRefreshLoop();
                        } else {
                            if (typeof stopTrackerRefreshLoop === 'function') stopTrackerRefreshLoop();
                        }
                    }
                });
                if (weatherCb) weatherCb.addEventListener('change', async ()=>{ const ok = await postToggle('/api/weather/toggle', weatherCb.checked); if (!ok) alert('Failed to update Weather'); });
            } catch (e) { console.error('Service toggles setup failed', e); }
        }
        setupServiceToggles();
  });
})();
</script>

</body>
</html>
